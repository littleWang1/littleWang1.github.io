<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="分布式搜索引擎03" /><meta name="author" content="superWang" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="分布式搜索引擎03" /><meta property="og:description" content="分布式搜索引擎03" /><link rel="canonical" href="/posts/%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E03/" /><meta property="og:url" content="/posts/%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E03/" /><meta property="og:site_name" content="小牛" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-03-12T02:34:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="分布式搜索引擎03" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@superWang" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"superWang"},"dateModified":"2024-03-12T02:34:00+00:00","datePublished":"2024-03-12T02:34:00+00:00","description":"分布式搜索引擎03","headline":"分布式搜索引擎03","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E03/"},"url":"/posts/%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E03/"}</script><title>分布式搜索引擎03 | 小牛</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="小牛"><meta name="application-name" content="小牛"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/config/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">小牛</a></div><div class="site-subtitle font-italic">这里是小牛的博客～</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/littleWang1" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['1657498912','qq.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>分布式搜索引擎03</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>分布式搜索引擎03</h1><div class="post-meta text-muted"> <span> 发表于 <em class="" data-ts="1710210840" data-df="YYYY/MM/DD" data-toggle="tooltip" data-placement="bottom"> 2024/03/12 </em> </span><div class="d-flex justify-content-between"> <span> 作者 <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="6900 字"> <em>38 分钟</em>阅读</span></div></div></div><div class="post-content"><h1 id="分布式搜索引擎03">分布式搜索引擎03</h1><h1 id="0学习目标">0.学习目标</h1><h1 id="1数据聚合">1.数据聚合</h1><p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">聚合（</a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">aggregations</a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">）</a></strong>可以让我们极其方便的实现对数据的统计、分析、运算。例如：</p><ul><li>什么品牌的手机最受欢迎？<li>这些手机的平均价格、最高价格、最低价格？<li>这些手机每月的销售情况如何？</ul><p>实现这些统计功能的比数据库的sql要方便的多，而且查询速度非常快，可以实现近实时搜索效果。</p><h2 id="11聚合的种类"><span class="mr-2">1.1.聚合的种类</span><a href="#11聚合的种类" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>聚合常见的有三类：</p><ul><li><strong>桶（Bucket）</strong>聚合：用来对文档做分组<ul><li>TermAggregation：按照文档字段值分组，例如按照品牌值分组、按照国家分组<li>Date Histogram：按照日期阶梯分组，例如一周为一组，或者一月为一组</ul><li><strong>度量（Metric）</strong>聚合：用以计算一些值，比如：最大值、最小值、平均值等<ul><li>Avg：求平均值<li>Max：求最大值<li>Min：求最小值<li>Stats：同时求max、min、avg、sum等</ul><li><strong>管道（pipeline）</strong>聚合：其它聚合的结果为基础做聚合</ul><blockquote><p><strong>注意：</strong>参加聚合的字段必须是keyword、日期、数值、布尔类型</p></blockquote><h2 id="12dsl实现聚合"><span class="mr-2">1.2.DSL实现聚合</span><a href="#12dsl实现聚合" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>现在，我们要统计所有数据中的酒店品牌有几种，其实就是按照品牌对数据分组。此时可以根据酒店品牌的名称做聚合，也就是Bucket聚合。</p><h3 id="121bucket聚合语法"><span class="mr-2">1.2.1.Bucket聚合语法</span><a href="#121bucket聚合语法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>语法如下：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="err">GET /hotel/_search</span><span class="w">
</span><span class="p">{</span><span class="w">
</span><span class="err">  </span><span class="nl">"size"</span><span class="p">:</span><span class="err"> </span><span class="mi">0</span><span class="p">,</span><span class="err">  // 设置size为</span><span class="mi">0</span><span class="err">，结果中不包含文档，只包含聚合结果</span><span class="w">
</span><span class="err">  </span><span class="nl">"aggs"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="err"> // 定义聚合</span><span class="w">
</span><span class="err">    </span><span class="nl">"brandAgg"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="err"> //给聚合起个名字</span><span class="w">
</span><span class="err">      </span><span class="nl">"terms"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="err"> // 聚合的类型，按照品牌值聚合，所以选择term</span><span class="w">
</span><span class="err">        </span><span class="nl">"field"</span><span class="p">:</span><span class="err"> </span><span class="s2">"brand"</span><span class="p">,</span><span class="err"> // 参与聚合的字段</span><span class="w">
</span><span class="err">        </span><span class="nl">"size"</span><span class="p">:</span><span class="err"> </span><span class="mi">20</span><span class="err"> // 希望获取的聚合结果数量</span><span class="w">
</span><span class="err">      </span><span class="p">}</span><span class="w">
</span><span class="err">    </span><span class="p">}</span><span class="w">
</span><span class="err">  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>结果如图：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723171948228.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723171948228.png" alt="image-20210723171948228" class="lazyload" data-proofer-ignore></a></p><h3 id="122聚合结果排序"><span class="mr-2">1.2.2.聚合结果排序</span><a href="#122聚合结果排序" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>默认情况下，Bucket聚合会统计Bucket内的文档数量，记为_count，并且按照_count降序排序。</p><p>我们可以指定order属性，自定义聚合的排序方式：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="err">GET /hotel/_search</span><span class="w">
</span><span class="p">{</span><span class="w">
</span><span class="err">  </span><span class="nl">"size"</span><span class="p">:</span><span class="err"> </span><span class="mi">0</span><span class="p">,</span><span class="err"> </span><span class="w">
</span><span class="err">  </span><span class="nl">"aggs"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">    </span><span class="nl">"brandAgg"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">      </span><span class="nl">"terms"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">        </span><span class="nl">"field"</span><span class="p">:</span><span class="err"> </span><span class="s2">"brand"</span><span class="p">,</span><span class="w">
</span><span class="err">        </span><span class="nl">"order"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">          </span><span class="nl">"_count"</span><span class="p">:</span><span class="err"> </span><span class="s2">"asc"</span><span class="w"> </span><span class="err">// 按照_count升序排列</span><span class="w">
</span><span class="err">        </span><span class="p">},</span><span class="w">
</span><span class="err">        </span><span class="nl">"size"</span><span class="p">:</span><span class="err"> </span><span class="mi">20</span><span class="w">
</span><span class="err">      </span><span class="p">}</span><span class="w">
</span><span class="err">    </span><span class="p">}</span><span class="w">
</span><span class="err">  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h3 id="123限定聚合范围"><span class="mr-2">1.2.3.限定聚合范围</span><a href="#123限定聚合范围" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>默认情况下，Bucket聚合是对索引库的所有文档做聚合，但真实场景下，用户会输入搜索条件，因此聚合必须是对搜索结果聚合。那么聚合必须添加限定条件。</p><p>我们可以限定要聚合的文档范围，只要添加query条件即可：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="err">GET /hotel/_search</span><span class="w">
</span><span class="p">{</span><span class="w">
</span><span class="err">  </span><span class="nl">"query"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">    </span><span class="nl">"range"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">      </span><span class="nl">"price"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">        </span><span class="nl">"lte"</span><span class="p">:</span><span class="err"> </span><span class="mi">200</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">只对</span><span class="mi">200</span><span class="err">元以下的文档聚合</span><span class="w">
</span><span class="err">      </span><span class="p">}</span><span class="w">
</span><span class="err">    </span><span class="p">}</span><span class="w">
</span><span class="err">  </span><span class="p">},</span><span class="err"> </span><span class="w">
</span><span class="err">  </span><span class="nl">"size"</span><span class="p">:</span><span class="err"> </span><span class="mi">0</span><span class="p">,</span><span class="err"> </span><span class="w">
</span><span class="err">  </span><span class="nl">"aggs"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">    </span><span class="nl">"brandAgg"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">      </span><span class="nl">"terms"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">        </span><span class="nl">"field"</span><span class="p">:</span><span class="err"> </span><span class="s2">"brand"</span><span class="p">,</span><span class="w">
</span><span class="err">        </span><span class="nl">"size"</span><span class="p">:</span><span class="err"> </span><span class="mi">20</span><span class="w">
</span><span class="err">      </span><span class="p">}</span><span class="w">
</span><span class="err">    </span><span class="p">}</span><span class="w">
</span><span class="err">  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>这次，聚合得到的品牌明显变少了：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723172404836.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723172404836.png" alt="image-20210723172404836" class="lazyload" data-proofer-ignore></a></p><h3 id="124metric聚合语法"><span class="mr-2">1.2.4.Metric聚合语法</span><a href="#124metric聚合语法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>上节课，我们对酒店按照品牌分组，形成了一个个桶。现在我们需要对桶内的酒店做运算，获取每个品牌的用户评分的min、max、avg等值。</p><p>这就要用到Metric聚合了，例如stat聚合：就可以获取min、max、avg等结果。</p><p>语法如下：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="err">GET /hotel/_search</span><span class="w">
</span><span class="p">{</span><span class="w">
</span><span class="err">  </span><span class="nl">"size"</span><span class="p">:</span><span class="err"> </span><span class="mi">0</span><span class="p">,</span><span class="err"> </span><span class="w">
</span><span class="err">  </span><span class="nl">"aggs"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">    </span><span class="nl">"brandAgg"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="err"> </span><span class="w">
</span><span class="err">      </span><span class="nl">"terms"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="err"> </span><span class="w">
</span><span class="err">        </span><span class="nl">"field"</span><span class="p">:</span><span class="err"> </span><span class="s2">"brand"</span><span class="p">,</span><span class="err"> </span><span class="w">
</span><span class="err">        </span><span class="nl">"size"</span><span class="p">:</span><span class="err"> </span><span class="mi">20</span><span class="w">
</span><span class="err">      </span><span class="p">},</span><span class="w">
</span><span class="err">      </span><span class="nl">"aggs"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="err"> // 是brands聚合的子聚合，也就是分组后对每组分别计算</span><span class="w">
</span><span class="err">        </span><span class="nl">"score_stats"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="err"> // 聚合名称</span><span class="w">
</span><span class="err">          </span><span class="nl">"stats"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="err"> // 聚合类型，这里stats可以计算min、max、avg等</span><span class="w">
</span><span class="err">            </span><span class="nl">"field"</span><span class="p">:</span><span class="err"> </span><span class="s2">"score"</span><span class="err"> // 聚合字段，这里是score</span><span class="w">
</span><span class="err">          </span><span class="p">}</span><span class="w">
</span><span class="err">        </span><span class="p">}</span><span class="w">
</span><span class="err">      </span><span class="p">}</span><span class="w">
</span><span class="err">    </span><span class="p">}</span><span class="w">
</span><span class="err">  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>这次的score_stats聚合是在brandAgg的聚合内部嵌套的子聚合。因为我们需要在每个桶分别计算。</p><p>另外，我们还可以给聚合结果做个排序，例如按照每个桶的酒店平均分做排序：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723172917636.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723172917636.png" alt="image-20210723172917636" class="lazyload" data-proofer-ignore></a></p><h3 id="125小结"><span class="mr-2">1.2.5.小结</span><a href="#125小结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>aggs代表聚合，与query同级，此时query的作用是？</p><ul><li>限定聚合的的文档范围</ul><p>聚合必须的三要素：</p><ul><li>聚合名称<li>聚合类型<li>聚合字段</ul><p>聚合可配置属性有：</p><ul><li>size：指定聚合结果数量<li>order：指定聚合结果排序方式<li>field：指定聚合字段</ul><h2 id="13restapi实现聚合"><span class="mr-2">1.3.RestAPI实现聚合</span><a href="#13restapi实现聚合" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="131api语法"><span class="mr-2">1.3.1.API语法</span><a href="#131api语法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>聚合条件与query条件同级别，因此需要使用request.source()来指定聚合条件。</p><p>聚合条件的语法：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723173057733.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723173057733.png" alt="image-20210723173057733" class="lazyload" data-proofer-ignore></a></p><p>聚合的结果也与查询结果不同，API也比较特殊。不过同样是JSON逐层解析：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723173215728.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723173215728.png" alt="image-20210723173215728" class="lazyload" data-proofer-ignore></a></p><h3 id="132业务需求"><span class="mr-2">1.3.2.业务需求</span><a href="#132业务需求" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>需求：搜索页面的品牌、城市等信息不应该是在页面写死，而是通过聚合索引库中的酒店数据得来的：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723192605566.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723192605566.png" alt="image-20210723192605566" class="lazyload" data-proofer-ignore></a></p><p>分析：</p><p>目前，页面的城市列表、星级列表、品牌列表都是写死的，并不会随着搜索结果的变化而变化。但是用户搜索条件改变时，搜索结果会跟着变化。</p><p>例如：用户搜索“东方明珠”，那搜索的酒店肯定是在上海东方明珠附近，因此，城市只能是上海，此时城市列表中就不应该显示北京、深圳、杭州这些信息了。</p><p>也就是说，搜索结果中包含哪些城市，页面就应该列出哪些城市；搜索结果中包含哪些品牌，页面就应该列出哪些品牌。</p><p>如何得知搜索结果中包含哪些品牌？如何得知搜索结果中包含哪些城市？</p><p>使用聚合功能，利用Bucket聚合，对搜索结果中的文档基于品牌分组、基于城市分组，就能得知包含哪些品牌、哪些城市了。</p><p>因为是对搜索结果聚合，因此聚合是<strong>限定范围的聚合</strong>，也就是说聚合的限定条件跟搜索文档的条件一致。</p><p>查看浏览器可以发现，前端其实已经发出了这样的一个请求：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723193730799.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723193730799.png" alt="image-20210723193730799" class="lazyload" data-proofer-ignore></a></p><p>请求<strong>参数与搜索文档的参数完全一致</strong>。</p><p>返回值类型就是页面要展示的最终结果：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723203915982.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723203915982.png" alt="image-20210723203915982" class="lazyload" data-proofer-ignore></a></p><p>结果是一个Map结构：</p><ul><li>key是字符串，城市、星级、品牌、价格<li>value是集合，例如多个城市的名称</ul><h3 id="133业务实现"><span class="mr-2">1.3.3.业务实现</span><a href="#133业务实现" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在<code class="language-plaintext highlighter-rouge">cn.itcast.hotel.web</code>包的<code class="language-plaintext highlighter-rouge">HotelController</code>中添加一个方法，遵循下面的要求：</p><ul><li>请求方式：<code class="language-plaintext highlighter-rouge">POST</code><li>请求路径：<code class="language-plaintext highlighter-rouge">/hotel/filters</code><li>请求参数：<code class="language-plaintext highlighter-rouge">RequestParams</code>，与搜索文档的参数一致<li>返回值类型：<code class="language-plaintext highlighter-rouge">Map&lt;String, List&lt;String&gt;&gt;</code></ul><p>代码：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"filters"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="nf">getFilters</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">RequestParams</span> <span class="n">params</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">hotelService</span><span class="o">.</span><span class="na">getFilters</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>这里调用了IHotelService中的getFilters方法，尚未实现。</p><p>在<code class="language-plaintext highlighter-rouge">cn.itcast.hotel.service.IHotelService</code>中定义新方法：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="nf">filters</span><span class="o">(</span><span class="nc">RequestParams</span> <span class="n">params</span><span class="o">);</span>
</pre></table></code></div></div><p>在<code class="language-plaintext highlighter-rouge">cn.itcast.hotel.service.impl.HotelService</code>中实现该方法：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="nf">filters</span><span class="o">(</span><span class="nc">RequestParams</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 1.准备Request</span>
        <span class="nc">SearchRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SearchRequest</span><span class="o">(</span><span class="s">"hotel"</span><span class="o">);</span>
        <span class="c1">// 2.准备DSL</span>
        <span class="c1">// 2.1.query</span>
        <span class="n">buildBasicQuery</span><span class="o">(</span><span class="n">params</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
        <span class="c1">// 2.2.设置size</span>
        <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">size</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="c1">// 2.3.聚合</span>
        <span class="n">buildAggregation</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="c1">// 3.发出请求</span>
        <span class="nc">SearchResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="nc">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
        <span class="c1">// 4.解析结果</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="nc">Aggregations</span> <span class="n">aggregations</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getAggregations</span><span class="o">();</span>
        <span class="c1">// 4.1.根据品牌名称，获取品牌结果</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">brandList</span> <span class="o">=</span> <span class="n">getAggByName</span><span class="o">(</span><span class="n">aggregations</span><span class="o">,</span> <span class="s">"brandAgg"</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"品牌"</span><span class="o">,</span> <span class="n">brandList</span><span class="o">);</span>
        <span class="c1">// 4.2.根据品牌名称，获取品牌结果</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">cityList</span> <span class="o">=</span> <span class="n">getAggByName</span><span class="o">(</span><span class="n">aggregations</span><span class="o">,</span> <span class="s">"cityAgg"</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"城市"</span><span class="o">,</span> <span class="n">cityList</span><span class="o">);</span>
        <span class="c1">// 4.3.根据品牌名称，获取品牌结果</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">starList</span> <span class="o">=</span> <span class="n">getAggByName</span><span class="o">(</span><span class="n">aggregations</span><span class="o">,</span> <span class="s">"starAgg"</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"星级"</span><span class="o">,</span> <span class="n">starList</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">buildAggregation</span><span class="o">(</span><span class="nc">SearchRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">aggregation</span><span class="o">(</span><span class="nc">AggregationBuilders</span>
                                 <span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">"brandAgg"</span><span class="o">)</span>
                                 <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"brand"</span><span class="o">)</span>
                                 <span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
                                <span class="o">);</span>
    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">aggregation</span><span class="o">(</span><span class="nc">AggregationBuilders</span>
                                 <span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">"cityAgg"</span><span class="o">)</span>
                                 <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"city"</span><span class="o">)</span>
                                 <span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
                                <span class="o">);</span>
    <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">aggregation</span><span class="o">(</span><span class="nc">AggregationBuilders</span>
                                 <span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="s">"starAgg"</span><span class="o">)</span>
                                 <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"starName"</span><span class="o">)</span>
                                 <span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
                                <span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getAggByName</span><span class="o">(</span><span class="nc">Aggregations</span> <span class="n">aggregations</span><span class="o">,</span> <span class="nc">String</span> <span class="n">aggName</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 4.1.根据聚合名称获取聚合结果</span>
    <span class="nc">Terms</span> <span class="n">brandTerms</span> <span class="o">=</span> <span class="n">aggregations</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">aggName</span><span class="o">);</span>
    <span class="c1">// 4.2.获取buckets</span>
    <span class="nc">List</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Terms</span><span class="o">.</span><span class="na">Bucket</span><span class="o">&gt;</span> <span class="n">buckets</span> <span class="o">=</span> <span class="n">brandTerms</span><span class="o">.</span><span class="na">getBuckets</span><span class="o">();</span>
    <span class="c1">// 4.3.遍历</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">brandList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Terms</span><span class="o">.</span><span class="na">Bucket</span> <span class="n">bucket</span> <span class="o">:</span> <span class="n">buckets</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 4.4.获取key</span>
        <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="na">getKeyAsString</span><span class="o">();</span>
        <span class="n">brandList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">brandList</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h1 id="2自动补全">2.自动补全</h1><p>当用户在搜索框输入字符时，我们应该提示出与该字符有关的搜索项，如图：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723204936367.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723204936367.png" alt="image-20210723204936367" class="lazyload" data-proofer-ignore></a></p><p>这种根据用户输入的字母，提示完整词条的功能，就是自动补全了。</p><p>因为需要根据拼音字母来推断，因此要用到拼音分词功能。</p><h2 id="21拼音分词器"><span class="mr-2">2.1.拼音分词器</span><a href="#21拼音分词器" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>要实现根据字母做补全，就必须对文档按照拼音分词。在GitHub上恰好有elasticsearch的拼音分词插件。地址：https://github.com/medcl/elasticsearch-analysis-pinyin</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723205932746.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723205932746.png" alt="image-20210723205932746" class="lazyload" data-proofer-ignore></a></p><p>课前资料中也提供了拼音分词器的安装包：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723205722303.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723205722303.png" alt="image-20210723205722303" class="lazyload" data-proofer-ignore></a></p><p>安装方式与IK分词器一样，分三步：</p><p>​ ①解压</p><p>​ ②上传到虚拟机中，elasticsearch的plugin目录</p><p>​ ③重启elasticsearch</p><p>​ ④测试</p><p>详细安装步骤可以参考IK分词器的安装过程。</p><p>测试用法如下：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="err">POST /_analyze</span><span class="w">
</span><span class="p">{</span><span class="w">
</span><span class="err">  </span><span class="nl">"text"</span><span class="p">:</span><span class="err"> </span><span class="s2">"如家酒店还不错"</span><span class="p">,</span><span class="w">
</span><span class="err">  </span><span class="nl">"analyzer"</span><span class="p">:</span><span class="err"> </span><span class="s2">"pinyin"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>结果：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723210126506.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723210126506.png" alt="image-20210723210126506" class="lazyload" data-proofer-ignore></a></p><h2 id="22自定义分词器"><span class="mr-2">2.2.自定义分词器</span><a href="#22自定义分词器" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>默认的拼音分词器会将每个汉字单独分为拼音，而我们希望的是每个词条形成一组拼音，需要对拼音分词器做个性化定制，形成自定义分词器。</p><p>elasticsearch中分词器（analyzer）的组成包含三部分：</p><ul><li>character filters：在tokenizer之前对文本进行处理。例如删除字符、替换字符<li>tokenizer：将文本按照一定的规则切割成词条（term）。例如keyword，就是不分词；还有ik_smart<li>tokenizer filter：将tokenizer输出的词条做进一步处理。例如大小写转换、同义词处理、拼音处理等</ul><p>文档分词时会依次由这三部分来处理文档：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723210427878.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723210427878.png" alt="image-20210723210427878" class="lazyload" data-proofer-ignore></a></p><p>声明自定义分词器的语法如下：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="err">PUT /test</span><span class="w">
</span><span class="p">{</span><span class="w">
</span><span class="err">  </span><span class="nl">"settings"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">    </span><span class="nl">"analysis"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">      </span><span class="nl">"analyzer"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="err"> // 自定义分词器</span><span class="w">
</span><span class="err">        </span><span class="nl">"my_analyzer"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="err">  // 分词器名称</span><span class="w">
</span><span class="err">          </span><span class="nl">"tokenizer"</span><span class="p">:</span><span class="err"> </span><span class="s2">"ik_max_word"</span><span class="p">,</span><span class="w">
</span><span class="err">          </span><span class="nl">"filter"</span><span class="p">:</span><span class="err"> </span><span class="s2">"py"</span><span class="w">
</span><span class="err">        </span><span class="p">}</span><span class="w">
</span><span class="err">      </span><span class="p">},</span><span class="w">
</span><span class="err">      </span><span class="nl">"filter"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="err"> // 自定义tokenizer filter</span><span class="w">
</span><span class="err">        </span><span class="nl">"py"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="err"> // 过滤器名称</span><span class="w">
</span><span class="err">          </span><span class="nl">"type"</span><span class="p">:</span><span class="err"> </span><span class="s2">"pinyin"</span><span class="p">,</span><span class="err"> // 过滤器类型，这里是pinyin</span><span class="w">
		  </span><span class="nl">"keep_full_pinyin"</span><span class="p">:</span><span class="err"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
</span><span class="err">          </span><span class="nl">"keep_joined_full_pinyin"</span><span class="p">:</span><span class="err"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
</span><span class="err">          </span><span class="nl">"keep_original"</span><span class="p">:</span><span class="err"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
</span><span class="err">          </span><span class="nl">"limit_first_letter_length"</span><span class="p">:</span><span class="err"> </span><span class="mi">16</span><span class="p">,</span><span class="w">
</span><span class="err">          </span><span class="nl">"remove_duplicated_term"</span><span class="p">:</span><span class="err"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
</span><span class="err">          </span><span class="nl">"none_chinese_pinyin_tokenize"</span><span class="p">:</span><span class="err"> </span><span class="kc">false</span><span class="w">
</span><span class="err">        </span><span class="p">}</span><span class="w">
</span><span class="err">      </span><span class="p">}</span><span class="w">
</span><span class="err">    </span><span class="p">}</span><span class="w">
</span><span class="err">  </span><span class="p">},</span><span class="w">
</span><span class="err">  </span><span class="nl">"mappings"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">    </span><span class="nl">"properties"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">      </span><span class="nl">"name"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">        </span><span class="nl">"type"</span><span class="p">:</span><span class="err"> </span><span class="s2">"text"</span><span class="p">,</span><span class="w">
</span><span class="err">        </span><span class="nl">"analyzer"</span><span class="p">:</span><span class="err"> </span><span class="s2">"my_analyzer"</span><span class="p">,</span><span class="w">
</span><span class="err">        </span><span class="nl">"search_analyzer"</span><span class="p">:</span><span class="err"> </span><span class="s2">"ik_smart"</span><span class="w">
</span><span class="err">      </span><span class="p">}</span><span class="w">
</span><span class="err">    </span><span class="p">}</span><span class="w">
</span><span class="err">  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>测试：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723211829150.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723211829150.png" alt="image-20210723211829150" class="lazyload" data-proofer-ignore></a></p><p>总结：</p><p>如何使用拼音分词器？</p><ul><li><p>①下载pinyin分词器</p><li><p>②解压并放到elasticsearch的plugin目录</p><li><p>③重启即可</p></ul><p>如何自定义分词器？</p><ul><li><p>①创建索引库时，在settings中配置，可以包含三部分</p><li><p>②character filter</p><li><p>③tokenizer</p><li><p>④filter</p></ul><p>拼音分词器注意事项？</p><ul><li>为了避免搜索到同音字，搜索时不要使用拼音分词器</ul><h2 id="23自动补全查询"><span class="mr-2">2.3.自动补全查询</span><a href="#23自动补全查询" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>elasticsearch提供了<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html">Completion Suggester</a>查询来实现自动补全功能。这个查询会匹配以用户输入内容开头的词条并返回。为了提高补全查询的效率，对于文档中字段的类型有一些约束：</p><ul><li><p>参与补全查询的字段必须是completion类型。</p><li><p>字段的内容一般是用来补全的多个词条形成的数组。</p></ul><p>比如，一个这样的索引库：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="err">// 创建索引库</span><span class="w">
</span><span class="err">PUT test</span><span class="w">
</span><span class="p">{</span><span class="w">
</span><span class="err">  </span><span class="nl">"mappings"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">    </span><span class="nl">"properties"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">      </span><span class="nl">"title"</span><span class="p">:{</span><span class="w">
</span><span class="err">        </span><span class="nl">"type"</span><span class="p">:</span><span class="err"> </span><span class="s2">"completion"</span><span class="w">
</span><span class="err">      </span><span class="p">}</span><span class="w">
</span><span class="err">    </span><span class="p">}</span><span class="w">
</span><span class="err">  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>然后插入下面的数据：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="err">//</span><span class="w"> </span><span class="err">示例数据</span><span class="w">
</span><span class="err">POST test/_doc</span><span class="w">
</span><span class="p">{</span><span class="w">
</span><span class="err">  </span><span class="nl">"title"</span><span class="p">:</span><span class="err"> </span><span class="p">[</span><span class="s2">"Sony"</span><span class="p">,</span><span class="err"> </span><span class="s2">"WH-1000XM3"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="err">POST test/_doc</span><span class="w">
</span><span class="p">{</span><span class="w">
</span><span class="err">  </span><span class="nl">"title"</span><span class="p">:</span><span class="err"> </span><span class="p">[</span><span class="s2">"SK-II"</span><span class="p">,</span><span class="err"> </span><span class="s2">"PITERA"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="err">POST test/_doc</span><span class="w">
</span><span class="p">{</span><span class="w">
</span><span class="err">  </span><span class="nl">"title"</span><span class="p">:</span><span class="err"> </span><span class="p">[</span><span class="s2">"Nintendo"</span><span class="p">,</span><span class="err"> </span><span class="s2">"switch"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>查询的DSL语句如下：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="err">// 自动补全查询</span><span class="w">
</span><span class="err">GET /test/_search</span><span class="w">
</span><span class="p">{</span><span class="w">
</span><span class="err">  </span><span class="nl">"suggest"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">    </span><span class="nl">"title_suggest"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">      </span><span class="nl">"text"</span><span class="p">:</span><span class="err"> </span><span class="s2">"s"</span><span class="p">,</span><span class="err"> // 关键字</span><span class="w">
</span><span class="err">      </span><span class="nl">"completion"</span><span class="p">:</span><span class="err"> </span><span class="p">{</span><span class="w">
</span><span class="err">        </span><span class="nl">"field"</span><span class="p">:</span><span class="err"> </span><span class="s2">"title"</span><span class="p">,</span><span class="err"> // 补全查询的字段</span><span class="w">
</span><span class="err">        </span><span class="nl">"skip_duplicates"</span><span class="p">:</span><span class="err"> </span><span class="kc">true</span><span class="p">,</span><span class="err"> // 跳过重复的</span><span class="w">
</span><span class="err">        </span><span class="nl">"size"</span><span class="p">:</span><span class="err"> </span><span class="mi">10</span><span class="err"> // 获取前</span><span class="mi">10</span><span class="err">条结果</span><span class="w">
</span><span class="err">      </span><span class="p">}</span><span class="w">
</span><span class="err">    </span><span class="p">}</span><span class="w">
</span><span class="err">  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h2 id="24实现酒店搜索框自动补全"><span class="mr-2">2.4.实现酒店搜索框自动补全</span><a href="#24实现酒店搜索框自动补全" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>现在，我们的hotel索引库还没有设置拼音分词器，需要修改索引库中的配置。但是我们知道索引库是无法修改的，只能删除然后重新创建。</p><p>另外，我们需要添加一个字段，用来做自动补全，将brand、suggestion、city等都放进去，作为自动补全的提示。</p><p>因此，总结一下，我们需要做的事情包括：</p><ol><li><p>修改hotel索引库结构，设置自定义拼音分词器</p><li><p>修改索引库的name、all字段，使用自定义分词器</p><li><p>索引库添加一个新字段suggestion，类型为completion类型，使用自定义的分词器</p><li><p>给HotelDoc类添加suggestion字段，内容包含brand、business</p><li><p>重新导入数据到hotel库</p></ol><h3 id="241修改酒店映射结构"><span class="mr-2">2.4.1.修改酒店映射结构</span><a href="#241修改酒店映射结构" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>代码如下：</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre><td class="rouge-code"><pre><span class="err">//</span><span class="w"> </span><span class="err">酒店数据索引库</span><span class="w">
</span><span class="err">PUT</span><span class="w"> </span><span class="err">/hotel</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"settings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"analysis"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"analyzer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"text_anlyzer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"tokenizer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ik_max_word"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="s2">"py"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"completion_analyzer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"tokenizer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="s2">"py"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"py"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pinyin"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"keep_full_pinyin"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nl">"keep_joined_full_pinyin"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="nl">"keep_original"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="nl">"limit_first_letter_length"</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w">
          </span><span class="nl">"remove_duplicated_term"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="nl">"none_chinese_pinyin_tokenize"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"mappings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"id"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"analyzer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text_anlyzer"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"search_analyzer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ik_smart"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"copy_to"</span><span class="p">:</span><span class="w"> </span><span class="s2">"all"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"address"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"index"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"price"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"score"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"brand"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"copy_to"</span><span class="p">:</span><span class="w"> </span><span class="s2">"all"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"city"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"starName"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"business"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"copy_to"</span><span class="p">:</span><span class="w"> </span><span class="s2">"all"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"location"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"geo_point"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"pic"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"index"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"all"</span><span class="p">:{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"analyzer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text_anlyzer"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"search_analyzer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ik_smart"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"suggestion"</span><span class="p">:{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"completion"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"analyzer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"completion_analyzer"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h3 id="242修改hoteldoc实体"><span class="mr-2">2.4.2.修改HotelDoc实体</span><a href="#242修改hoteldoc实体" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>HotelDoc中要添加一个字段，用来做自动补全，内容可以是酒店品牌、城市、商圈等信息。按照自动补全字段的要求，最好是这些字段的数组。</p><p>因此我们在HotelDoc中添加一个suggestion字段，类型为<code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code>，然后将brand、city、business等信息放到里面。</p><p>代码如下：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">cn.itcast.hotel.pojo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@Data</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HotelDoc</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">address</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">price</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">score</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">brand</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">city</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">starName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">business</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">location</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">pic</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Object</span> <span class="n">distance</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Boolean</span> <span class="n">isAD</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">suggestion</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">HotelDoc</span><span class="o">(</span><span class="nc">Hotel</span> <span class="n">hotel</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">hotel</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">hotel</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">address</span> <span class="o">=</span> <span class="n">hotel</span><span class="o">.</span><span class="na">getAddress</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">price</span> <span class="o">=</span> <span class="n">hotel</span><span class="o">.</span><span class="na">getPrice</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">score</span> <span class="o">=</span> <span class="n">hotel</span><span class="o">.</span><span class="na">getScore</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">brand</span> <span class="o">=</span> <span class="n">hotel</span><span class="o">.</span><span class="na">getBrand</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">city</span> <span class="o">=</span> <span class="n">hotel</span><span class="o">.</span><span class="na">getCity</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">starName</span> <span class="o">=</span> <span class="n">hotel</span><span class="o">.</span><span class="na">getStarName</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">business</span> <span class="o">=</span> <span class="n">hotel</span><span class="o">.</span><span class="na">getBusiness</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">location</span> <span class="o">=</span> <span class="n">hotel</span><span class="o">.</span><span class="na">getLatitude</span><span class="o">()</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">hotel</span><span class="o">.</span><span class="na">getLongitude</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pic</span> <span class="o">=</span> <span class="n">hotel</span><span class="o">.</span><span class="na">getPic</span><span class="o">();</span>
        <span class="c1">// 组装suggestion</span>
        <span class="k">if</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"/"</span><span class="o">)){</span>
            <span class="c1">// business有多个值，需要切割</span>
            <span class="nc">String</span><span class="o">[]</span> <span class="n">arr</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
            <span class="c1">// 添加元素</span>
            <span class="k">this</span><span class="o">.</span><span class="na">suggestion</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
            <span class="k">this</span><span class="o">.</span><span class="na">suggestion</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">brand</span><span class="o">);</span>
            <span class="nc">Collections</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">suggestion</span><span class="o">,</span> <span class="n">arr</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">suggestion</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">brand</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">business</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="243重新导入"><span class="mr-2">2.4.3.重新导入</span><a href="#243重新导入" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>重新执行之前编写的导入数据功能，可以看到新的酒店数据中包含了suggestion：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723213546183.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723213546183.png" alt="image-20210723213546183" class="lazyload" data-proofer-ignore></a></p><h3 id="244自动补全查询的javaapi"><span class="mr-2">2.4.4.自动补全查询的JavaAPI</span><a href="#244自动补全查询的javaapi" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>之前我们学习了自动补全查询的DSL，而没有学习对应的JavaAPI，这里给出一个示例：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723213759922.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723213759922.png" alt="image-20210723213759922" class="lazyload" data-proofer-ignore></a></p><p>而自动补全的结果也比较特殊，解析的代码如下：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723213917524.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723213917524.png" alt="image-20210723213917524" class="lazyload" data-proofer-ignore></a></p><h3 id="245实现搜索框自动补全"><span class="mr-2">2.4.5.实现搜索框自动补全</span><a href="#245实现搜索框自动补全" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>查看前端页面，可以发现当我们在输入框键入时，前端会发起ajax请求：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723214021062.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723214021062.png" alt="image-20210723214021062" class="lazyload" data-proofer-ignore></a></p><p>返回值是补全词条的集合，类型为<code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code></p><p>1）在<code class="language-plaintext highlighter-rouge">cn.itcast.hotel.web</code>包下的<code class="language-plaintext highlighter-rouge">HotelController</code>中添加新接口，接收新的请求：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"suggestion"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getSuggestions</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"key"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">hotelService</span><span class="o">.</span><span class="na">getSuggestions</span><span class="o">(</span><span class="n">prefix</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p>2）在<code class="language-plaintext highlighter-rouge">cn.itcast.hotel.service</code>包下的<code class="language-plaintext highlighter-rouge">IhotelService</code>中添加方法：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getSuggestions</span><span class="o">(</span><span class="nc">String</span> <span class="n">prefix</span><span class="o">);</span>
</pre></table></code></div></div><p>3）在<code class="language-plaintext highlighter-rouge">cn.itcast.hotel.service.impl.HotelService</code>中实现该方法：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getSuggestions</span><span class="o">(</span><span class="nc">String</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 1.准备Request</span>
        <span class="nc">SearchRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SearchRequest</span><span class="o">(</span><span class="s">"hotel"</span><span class="o">);</span>
        <span class="c1">// 2.准备DSL</span>
        <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">suggest</span><span class="o">(</span><span class="k">new</span> <span class="nc">SuggestBuilder</span><span class="o">().</span><span class="na">addSuggestion</span><span class="o">(</span>
            <span class="s">"suggestions"</span><span class="o">,</span>
            <span class="nc">SuggestBuilders</span><span class="o">.</span><span class="na">completionSuggestion</span><span class="o">(</span><span class="s">"suggestion"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">prefix</span><span class="o">(</span><span class="n">prefix</span><span class="o">)</span>
            <span class="o">.</span><span class="na">skipDuplicates</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
            <span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
        <span class="o">));</span>
        <span class="c1">// 3.发起请求</span>
        <span class="nc">SearchResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="nc">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
        <span class="c1">// 4.解析结果</span>
        <span class="nc">Suggest</span> <span class="n">suggest</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getSuggest</span><span class="o">();</span>
        <span class="c1">// 4.1.根据补全查询名称，获取补全结果</span>
        <span class="nc">CompletionSuggestion</span> <span class="n">suggestions</span> <span class="o">=</span> <span class="n">suggest</span><span class="o">.</span><span class="na">getSuggestion</span><span class="o">(</span><span class="s">"suggestions"</span><span class="o">);</span>
        <span class="c1">// 4.2.获取options</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">CompletionSuggestion</span><span class="o">.</span><span class="na">Entry</span><span class="o">.</span><span class="na">Option</span><span class="o">&gt;</span> <span class="n">options</span> <span class="o">=</span> <span class="n">suggestions</span><span class="o">.</span><span class="na">getOptions</span><span class="o">();</span>
        <span class="c1">// 4.3.遍历</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">options</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">CompletionSuggestion</span><span class="o">.</span><span class="na">Entry</span><span class="o">.</span><span class="na">Option</span> <span class="n">option</span> <span class="o">:</span> <span class="n">options</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">option</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
            <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">text</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h1 id="3数据同步">3.数据同步</h1><p>elasticsearch中的酒店数据来自于mysql数据库，因此mysql数据发生改变时，elasticsearch也必须跟着改变，这个就是elasticsearch与mysql之间的<strong>数据同步</strong>。</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723214758392.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723214758392.png" alt="image-20210723214758392" class="lazyload" data-proofer-ignore></a></p><h2 id="31思路分析"><span class="mr-2">3.1.思路分析</span><a href="#31思路分析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>常见的数据同步方案有三种：</p><ul><li>同步调用<li>异步通知<li>监听binlog</ul><h3 id="311同步调用"><span class="mr-2">3.1.1.同步调用</span><a href="#311同步调用" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>方案一：同步调用</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723214931869.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723214931869.png" alt="image-20210723214931869" class="lazyload" data-proofer-ignore></a></p><p>基本步骤如下：</p><ul><li>hotel-demo对外提供接口，用来修改elasticsearch中的数据<li>酒店管理服务在完成数据库操作后，直接调用hotel-demo提供的接口，</ul><h3 id="312异步通知"><span class="mr-2">3.1.2.异步通知</span><a href="#312异步通知" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>方案二：异步通知</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723215140735.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723215140735.png" alt="image-20210723215140735" class="lazyload" data-proofer-ignore></a></p><p>流程如下：</p><ul><li>hotel-admin对mysql数据库数据完成增、删、改后，发送MQ消息<li>hotel-demo监听MQ，接收到消息后完成elasticsearch数据修改</ul><h3 id="313监听binlog"><span class="mr-2">3.1.3.监听binlog</span><a href="#313监听binlog" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>方案三：监听binlog</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723215518541.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723215518541.png" alt="image-20210723215518541" class="lazyload" data-proofer-ignore></a></p><p>流程如下：</p><ul><li>给mysql开启binlog功能<li>mysql完成增、删、改操作都会记录在binlog中<li>hotel-demo基于canal监听binlog变化，实时更新elasticsearch中的内容</ul><h3 id="314选择"><span class="mr-2">3.1.4.选择</span><a href="#314选择" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>方式一：同步调用</p><ul><li>优点：实现简单，粗暴<li>缺点：业务耦合度高</ul><p>方式二：异步通知</p><ul><li>优点：低耦合，实现难度一般<li>缺点：依赖mq的可靠性</ul><p>方式三：监听binlog</p><ul><li>优点：完全解除服务间耦合<li>缺点：开启binlog增加数据库负担、实现复杂度高</ul><h2 id="32实现数据同步"><span class="mr-2">3.2.实现数据同步</span><a href="#32实现数据同步" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="321思路"><span class="mr-2">3.2.1.思路</span><a href="#321思路" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>利用课前资料提供的hotel-admin项目作为酒店管理的微服务。当酒店数据发生增、删、改时，要求对elasticsearch中数据也要完成相同操作。</p><p>步骤：</p><ul><li><p>导入课前资料提供的hotel-admin项目，启动并测试酒店数据的CRUD</p><li><p>声明exchange、queue、RoutingKey</p><li><p>在hotel-admin中的增、删、改业务中完成消息发送</p><li><p>在hotel-demo中完成消息监听，并更新elasticsearch中数据</p><li><p>启动并测试数据同步功能</p></ul><h3 id="322导入demo"><span class="mr-2">3.2.2.导入demo</span><a href="#322导入demo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>导入课前资料提供的hotel-admin项目：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723220237930.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723220237930.png" alt="image-20210723220237930" class="lazyload" data-proofer-ignore></a></p><p>运行后，访问 http://localhost:8099</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723220354464.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723220354464.png" alt="image-20210723220354464" class="lazyload" data-proofer-ignore></a></p><p>其中包含了酒店的CRUD功能：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723220511090.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723220511090.png" alt="image-20210723220511090" class="lazyload" data-proofer-ignore></a></p><h3 id="323声明交换机队列"><span class="mr-2">3.2.3.声明交换机、队列</span><a href="#323声明交换机队列" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>MQ结构如图：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723215850307.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723215850307.png" alt="image-20210723215850307" class="lazyload" data-proofer-ignore></a></p><h4 id="1引入依赖"><span class="mr-2">1）引入依赖</span><a href="#1引入依赖" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>在hotel-admin、hotel-demo中引入rabbitmq的依赖：</p><div class="language-xml highlighter-rouge"><div class="code-header"> <span data-label-text="XML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c">&lt;!--amqp--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></table></code></div></div><h4 id="2声明队列交换机名称"><span class="mr-2">2）声明队列交换机名称</span><a href="#2声明队列交换机名称" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>在hotel-admin和hotel-demo中的<code class="language-plaintext highlighter-rouge">cn.itcast.hotel.constatnts</code>包下新建一个类<code class="language-plaintext highlighter-rouge">MqConstants</code>：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">cn.itcast.hotel.constatnts</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">MqConstants</span> <span class="o">{</span>
    <span class="cm">/**
     * 交换机
     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">HOTEL_EXCHANGE</span> <span class="o">=</span> <span class="s">"hotel.topic"</span><span class="o">;</span>
    <span class="cm">/**
     * 监听新增和修改的队列
     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">HOTEL_INSERT_QUEUE</span> <span class="o">=</span> <span class="s">"hotel.insert.queue"</span><span class="o">;</span>
    <span class="cm">/**
     * 监听删除的队列
     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">HOTEL_DELETE_QUEUE</span> <span class="o">=</span> <span class="s">"hotel.delete.queue"</span><span class="o">;</span>
    <span class="cm">/**
     * 新增或修改的RoutingKey
     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">HOTEL_INSERT_KEY</span> <span class="o">=</span> <span class="s">"hotel.insert"</span><span class="o">;</span>
    <span class="cm">/**
     * 删除的RoutingKey
     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">HOTEL_DELETE_KEY</span> <span class="o">=</span> <span class="s">"hotel.delete"</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h4 id="3声明队列交换机"><span class="mr-2">3）声明队列交换机</span><a href="#3声明队列交换机" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>在hotel-demo中，定义配置类，声明队列、交换机：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">cn.itcast.hotel.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.itcast.hotel.constants.MqConstants</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.core.Binding</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.core.BindingBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.core.Queue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.core.TopicExchange</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MqConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">TopicExchange</span> <span class="nf">topicExchange</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">TopicExchange</span><span class="o">(</span><span class="nc">MqConstants</span><span class="o">.</span><span class="na">HOTEL_EXCHANGE</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Queue</span> <span class="nf">insertQueue</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Queue</span><span class="o">(</span><span class="nc">MqConstants</span><span class="o">.</span><span class="na">HOTEL_INSERT_QUEUE</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Queue</span> <span class="nf">deleteQueue</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Queue</span><span class="o">(</span><span class="nc">MqConstants</span><span class="o">.</span><span class="na">HOTEL_DELETE_QUEUE</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Binding</span> <span class="nf">insertQueueBinding</span><span class="o">(){</span>
        <span class="k">return</span> <span class="nc">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">insertQueue</span><span class="o">()).</span><span class="na">to</span><span class="o">(</span><span class="n">topicExchange</span><span class="o">()).</span><span class="na">with</span><span class="o">(</span><span class="nc">MqConstants</span><span class="o">.</span><span class="na">HOTEL_INSERT_KEY</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Binding</span> <span class="nf">deleteQueueBinding</span><span class="o">(){</span>
        <span class="k">return</span> <span class="nc">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">deleteQueue</span><span class="o">()).</span><span class="na">to</span><span class="o">(</span><span class="n">topicExchange</span><span class="o">()).</span><span class="na">with</span><span class="o">(</span><span class="nc">MqConstants</span><span class="o">.</span><span class="na">HOTEL_DELETE_KEY</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="324发送mq消息"><span class="mr-2">3.2.4.发送MQ消息</span><a href="#324发送mq消息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>在hotel-admin中的增、删、改业务中分别发送MQ消息：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723221843816.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723221843816.png" alt="image-20210723221843816" class="lazyload" data-proofer-ignore></a></p><h3 id="325接收mq消息"><span class="mr-2">3.2.5.接收MQ消息</span><a href="#325接收mq消息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>hotel-demo接收到MQ消息要做的事情包括：</p><ul><li>新增消息：根据传递的hotel的id查询hotel信息，然后新增一条数据到索引库<li>删除消息：根据传递的hotel的id删除索引库中的一条数据</ul><p>1）首先在hotel-demo的<code class="language-plaintext highlighter-rouge">cn.itcast.hotel.service</code>包下的<code class="language-plaintext highlighter-rouge">IHotelService</code>中新增新增、删除业务</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">deleteById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>

<span class="kt">void</span> <span class="nf">insertById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>
</pre></table></code></div></div><p>2）给hotel-demo中的<code class="language-plaintext highlighter-rouge">cn.itcast.hotel.service.impl</code>包下的HotelService中实现业务：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 1.准备Request</span>
        <span class="nc">DeleteRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DeleteRequest</span><span class="o">(</span><span class="s">"hotel"</span><span class="o">,</span> <span class="n">id</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="c1">// 2.发送请求</span>
        <span class="n">client</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="nc">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">insertById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 0.根据id查询酒店数据</span>
        <span class="nc">Hotel</span> <span class="n">hotel</span> <span class="o">=</span> <span class="n">getById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="c1">// 转换为文档类型</span>
        <span class="nc">HotelDoc</span> <span class="n">hotelDoc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HotelDoc</span><span class="o">(</span><span class="n">hotel</span><span class="o">);</span>

        <span class="c1">// 1.准备Request对象</span>
        <span class="nc">IndexRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndexRequest</span><span class="o">(</span><span class="s">"hotel"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="n">hotel</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
        <span class="c1">// 2.准备Json文档</span>
        <span class="n">request</span><span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">hotelDoc</span><span class="o">),</span> <span class="nc">XContentType</span><span class="o">.</span><span class="na">JSON</span><span class="o">);</span>
        <span class="c1">// 3.发送请求</span>
        <span class="n">client</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="nc">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>3）编写监听器</p><p>在hotel-demo中的<code class="language-plaintext highlighter-rouge">cn.itcast.hotel.mq</code>包新增一个类：</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">cn.itcast.hotel.mq</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.itcast.hotel.constants.MqConstants</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.itcast.hotel.service.IHotelService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.annotation.RabbitListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HotelListener</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">IHotelService</span> <span class="n">hotelService</span><span class="o">;</span>

    <span class="cm">/**
     * 监听酒店新增或修改的业务
     * @param id 酒店id
     */</span>
    <span class="nd">@RabbitListener</span><span class="o">(</span><span class="n">queues</span> <span class="o">=</span> <span class="nc">MqConstants</span><span class="o">.</span><span class="na">HOTEL_INSERT_QUEUE</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">listenHotelInsertOrUpdate</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">){</span>
        <span class="n">hotelService</span><span class="o">.</span><span class="na">insertById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 监听酒店删除的业务
     * @param id 酒店id
     */</span>
    <span class="nd">@RabbitListener</span><span class="o">(</span><span class="n">queues</span> <span class="o">=</span> <span class="nc">MqConstants</span><span class="o">.</span><span class="na">HOTEL_DELETE_QUEUE</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">listenHotelDelete</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">){</span>
        <span class="n">hotelService</span><span class="o">.</span><span class="na">deleteById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h1 id="4集群">4.集群</h1><p>单机的elasticsearch做数据存储，必然面临两个问题：海量数据存储问题、单点故障问题。</p><ul><li>海量数据存储问题：将索引库从逻辑上拆分为N个分片（shard），存储到多个节点<li>单点故障问题：将分片数据在不同节点备份（replica ）</ul><p><strong>ES集群相关概念</strong>:</p><ul><li><p>集群（cluster）：一组拥有共同的 cluster name 的 节点。</p><li> <font color="red">节点（node)</font><p>：集群中的一个 Elasticearch 实例</p><li> <font color="red">分片（shard）</font><p>：索引可以被拆分为不同的部分进行存储，称为分片。在集群环境下，一个索引的不同分片可以拆分到不同的节点中</p><p>解决问题：数据量太大，单点存储量有限的问题。</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20200104124440086-5602723.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20200104124440086-5602723.png" alt="image-20200104124440086" class="lazyload" data-proofer-ignore></a></p><blockquote><p>此处，我们把数据分成3片：shard0、shard1、shard2</p></blockquote><li><p>主分片（Primary shard）：相对于副本分片的定义。</p><li><p>副本分片（Replica shard）每个主分片可以有一个或者多个副本，数据和主分片一样。</p><p>​</p></ul><p>数据备份可以保证高可用，但是每个分片备份一份，所需要的节点数量就会翻一倍，成本实在是太高了！</p><p>为了在高可用和成本间寻求平衡，我们可以这样做：</p><ul><li>首先对数据分片，存储到不同节点<li>然后对每个分片进行备份，放到对方节点，完成互相备份</ul><p>这样可以大大减少所需要的服务节点数量，如图，我们以3分片，每个分片备份一份为例：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20200104124551912.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20200104124551912.png" alt="image-20200104124551912" class="lazyload" data-proofer-ignore></a></p><p>现在，每个分片都有1个备份，存储在3个节点：</p><ul><li>node0：保存了分片0和1<li>node1：保存了分片0和2<li>node2：保存了分片1和2</ul><h2 id="41搭建es集群"><span class="mr-2">4.1.搭建ES集群</span><a href="#41搭建es集群" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>参考课前资料的文档：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723222732427.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723222732427.png" alt="image-20210723222732427" class="lazyload" data-proofer-ignore></a></p><p>其中的第四章节：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723222812619.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723222812619.png" alt="image-20210723222812619" class="lazyload" data-proofer-ignore></a></p><h2 id="42集群脑裂问题"><span class="mr-2">4.2.集群脑裂问题</span><a href="#42集群脑裂问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="421集群职责划分"><span class="mr-2">4.2.1.集群职责划分</span><a href="#421集群职责划分" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>elasticsearch中集群节点有不同的职责划分：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723223008967.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723223008967.png" alt="image-20210723223008967" class="lazyload" data-proofer-ignore></a></p><p>默认情况下，集群中的任何一个节点都同时具备上述四种角色。</p><p>但是真实的集群一定要将集群职责分离：</p><ul><li>master节点：对CPU要求高，但是内存要求第<li>data节点：对CPU和内存要求都高<li>coordinating节点：对网络带宽、CPU要求高</ul><p>职责分离可以让我们根据不同节点的需求分配不同的硬件去部署。而且避免业务之间的互相干扰。</p><p>一个典型的es集群职责划分如图：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723223629142.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723223629142.png" alt="image-20210723223629142" class="lazyload" data-proofer-ignore></a></p><h3 id="422脑裂问题"><span class="mr-2">4.2.2.脑裂问题</span><a href="#422脑裂问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>脑裂是因为集群中的节点失联导致的。</p><p>例如一个集群中，主节点与其它节点失联：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723223804995.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723223804995.png" alt="image-20210723223804995" class="lazyload" data-proofer-ignore></a></p><p>此时，node2和node3认为node1宕机，就会重新选主：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723223845754.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723223845754.png" alt="image-20210723223845754" class="lazyload" data-proofer-ignore></a></p><p>当node3当选后，集群继续对外提供服务，node2和node3自成集群，node1自成集群，两个集群数据不同步，出现数据差异。</p><p>当网络恢复后，因为集群中有两个master节点，集群状态的不一致，出现脑裂的情况：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723224000555.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723224000555.png" alt="image-20210723224000555" class="lazyload" data-proofer-ignore></a></p><p>解决脑裂的方案是，要求选票超过 ( eligible节点数量 + 1 ）/ 2 才能当选为主，因此eligible节点数量最好是奇数。对应配置项是discovery.zen.minimum_master_nodes，在es7.0以后，已经成为默认配置，因此一般不会发生脑裂问题</p><p>例如：3个节点形成的集群，选票必须超过 （3 + 1） / 2 ，也就是2票。node3得到node2和node3的选票，当选为主。node1只有自己1票，没有当选。集群中依然只有1个主节点，没有出现脑裂。</p><h3 id="423小结"><span class="mr-2">4.2.3.小结</span><a href="#423小结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>master eligible节点的作用是什么？</p><ul><li>参与集群选主<li>主节点可以管理集群状态、管理分片信息、处理创建和删除索引库的请求</ul><p>data节点的作用是什么？</p><ul><li>数据的CRUD</ul><p>coordinator节点的作用是什么？</p><ul><li><p>路由请求到其它节点</p><li><p>合并查询到的结果，返回给用户</p></ul><h2 id="43集群分布式存储"><span class="mr-2">4.3.集群分布式存储</span><a href="#43集群分布式存储" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>当新增文档时，应该保存到不同分片，保证数据均衡，那么coordinating node如何确定数据该存储到哪个分片呢？</p><h3 id="431分片存储测试"><span class="mr-2">4.3.1.分片存储测试</span><a href="#431分片存储测试" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>插入三条数据：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225006058.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225006058.png" alt="image-20210723225006058" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225034637.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225034637.png" alt="image-20210723225034637" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225112029.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225112029.png" alt="image-20210723225112029" class="lazyload" data-proofer-ignore></a></p><p>测试可以看到，三条数据分别在不同分片：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225227928.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225227928.png" alt="image-20210723225227928" class="lazyload" data-proofer-ignore></a></p><p>结果：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225342120.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225342120.png" alt="image-20210723225342120" class="lazyload" data-proofer-ignore></a></p><h3 id="432分片存储原理"><span class="mr-2">4.3.2.分片存储原理</span><a href="#432分片存储原理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>elasticsearch会通过hash算法来计算文档应该存储到哪个分片：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723224354904.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723224354904.png" alt="image-20210723224354904" class="lazyload" data-proofer-ignore></a></p><p>说明：</p><ul><li>_routing默认是文档的id<li>算法与分片数量有关，因此索引库一旦创建，分片数量不能修改！</ul><p>新增文档的流程如下：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225436084.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225436084.png" alt="image-20210723225436084" class="lazyload" data-proofer-ignore></a></p><p>解读：</p><ul><li>1）新增一个id=1的文档<li>2）对id做hash运算，假如得到的是2，则应该存储到shard-2<li>3）shard-2的主分片在node3节点，将数据路由到node3<li>4）保存文档<li>5）同步给shard-2的副本replica-2，在node2节点<li>6）返回结果给coordinating-node节点</ul><h2 id="44集群分布式查询"><span class="mr-2">4.4.集群分布式查询</span><a href="#44集群分布式查询" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>elasticsearch的查询分成两个阶段：</p><ul><li><p>scatter phase：分散阶段，coordinating node会把请求分发到每一个分片</p><li><p>gather phase：聚集阶段，coordinating node汇总data node的搜索结果，并处理为最终结果集返回给用户</p></ul><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225809848.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225809848.png" alt="image-20210723225809848" class="lazyload" data-proofer-ignore></a></p><h2 id="45集群故障转移"><span class="mr-2">4.5.集群故障转移</span><a href="#45集群故障转移" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>集群的master节点会监控集群中的节点状态，如果发现有节点宕机，会立即将宕机节点的分片数据迁移到其它节点，确保数据安全，这个叫做故障转移。</p><p>1）例如一个集群结构如图：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225945963.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723225945963.png" alt="image-20210723225945963" class="lazyload" data-proofer-ignore></a></p><p>现在，node1是主节点，其它两个节点是从节点。</p><p>2）突然，node1发生了故障：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723230020574.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723230020574.png" alt="image-20210723230020574" class="lazyload" data-proofer-ignore></a></p><p>宕机后的第一件事，需要重新选主，例如选中了node2：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723230055974.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723230055974.png" alt="image-20210723230055974" class="lazyload" data-proofer-ignore></a></p><p>node2成为主节点后，会检测集群监控状态，发现：shard-1、shard-0没有副本节点。因此需要将node1上的数据迁移到node2、node3：</p><p><a href="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723230216642.png" class="popup img-link "><img data-src="/assets/blog_res/2024-03-12-分布式搜索引擎03.assets/image-20210723230216642.png" alt="image-20210723230216642" class="lazyload" data-proofer-ignore></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E6%B5%8B%E8%AF%95/'>测试</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/%E5%AD%A6%E4%B9%A0/" class="post-tag no-text-decoration" >学习</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E03%20-%20%E5%B0%8F%E7%89%9B&url=%2Fposts%2F%25E5%2588%2586%25E5%25B8%2583%25E5%25BC%258F%25E6%2590%259C%25E7%25B4%25A2%25E5%25BC%2595%25E6%2593%258E03%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E03%20-%20%E5%B0%8F%E7%89%9B&u=%2Fposts%2F%25E5%2588%2586%25E5%25B8%2583%25E5%25BC%258F%25E6%2590%259C%25E7%25B4%25A2%25E5%25BC%2595%25E6%2593%258E03%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2F%25E5%2588%2586%25E5%25B8%2583%25E5%25BC%258F%25E6%2590%259C%25E7%25B4%25A2%25E5%25BC%2595%25E6%2593%258E03%2F&text=%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E03%20-%20%E5%B0%8F%E7%89%9B" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/MVCC/">MVCC</a><li><a href="/posts/Redis/">Redis</a><li><a href="/posts/JAVA%E5%9F%BA%E7%A1%80/">JAVA基础</a><li><a href="/posts/%E9%9D%A2%E8%AF%95/">面试题总结</a><li><a href="/posts/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%80/">微服务一Nacos</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E5%AD%A6%E4%B9%A0/">学习</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%80/"><div class="card-body"> <em class="small" data-ts="1709778840" data-df="YYYY/MM/DD" > 2024/03/07 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>微服务一Nacos</h3><div class="text-muted small"><p> 1.微服务技术栈 持续集成 2.认识微服务 单体架构 分布式架构 认识微服务 springCloud与SpringBoot的版本兼容关系 微服务拆分注意事项 3.服务远程调用 步骤一： 步骤二： 消费者与提供者 4.Eureka注册中心 服务调用会出现问题比如： 这个时候需要Eureka可以解决这...</p></div></div></a></div><div class="card"> <a href="/posts/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%89/"><div class="card-body"> <em class="small" data-ts="1709865240" data-df="YYYY/MM/DD" > 2024/03/08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>微服务三-网关</h3><div class="text-muted small"><p> 1.网关功能 springCloud中网管有两种 gateway zuul 2.编写路由配置及nacos地址 路由断言工厂 过滤器工厂 全局过滤器 //@Order() @Component public class AuthorizeFilter implements GlobalFilter, Ordered ...</p></div></div></a></div><div class="card"> <a href="/posts/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BA%8C/"><div class="card-body"> <em class="small" data-ts="1709868840" data-df="YYYY/MM/DD" > 2024/03/08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>微服务二-Feign</h3><div class="text-muted small"><p> 1.为什么要用Feign 2.自定义Feign的配置 第一种方式，基于配置文件 第二种方式，基于java代码方式： 总结 3.Feign的性能优化 具体实现： 4.Feign的最佳实践 缺点：不推荐服务端和客户端共享接口，因为他会造成紧耦合，而且这种继承方案对MVC不起作用，其中实现逻辑和athVariable不能省还得自己...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E02/" class="btn btn-outline-primary" prompt="上一篇"><p>分布式搜索引擎02</p></a> <a href="/posts/MVCC/" class="btn btn-outline-primary" prompt="下一篇"><p>MVCC</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%E5%AD%A6%E4%B9%A0/">学习</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/littleWang1">小牛</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0">本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> (function () { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE ? "dark" : "default"); let config = {theme: expectedTheme}; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function () { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Create mermaid tag */ $("pre").has("code.language-mermaid").each(function () { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<pre class=\"mermaid\">${svgCode}</pre>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); })(); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/unregister.js"></script>
